---
title: 实现
description: 了解 Web 端的技术实现
authors:
  - flytreleft
---

import Header from '../../../../../\_header.md';

<Header />

## Vite 配置模块别名

```js {10} title="vite.config.js"
import path from 'path';
import { defineConfig } from 'vite';

export default defineConfig(() => {
  return {
    // ...
    resolve: {
      // https://stackoverflow.com/questions/66043612/vue3-vite-project-alias-src-to-not-working#answer-70251354
      alias: {
        '@/': path.join(__dirname, 'src/')
      }
    },
  };
});
```

## Vite 内联图片

```js {13,15} title="vite.config.js"
import { defineConfig } from 'vite';

export default defineConfig(() => {
  return {
    // ...
    css: {
      postcss: {
        plugins: [
          // https://github.com/bezoerb/postcss-image-inliner
          imageInliner({
            maxFileSize: 1024,
            // svg 以 Base64 编码内联
            b64Svg: true,
            // 配置正则表达式，以匹配需要内联的 css 属性
            filter: /^(background(?:-image)?)|(content)/
          })
        ]
      }
    },
  };
});
```

## 独立构建打包页面渲染器（`renderer`）

将页面渲染器单独构建打包需要注意以下事项：

- 单独构建页面渲染器的相关构建配置，不能影响正常的本地开发，
  同时需要避免对页面渲染器存在多种使用方式的情况
- 为避免页面渲染器打包文件过大，需要将页面渲染器所使用的渲染引擎代码作为依赖库单独构建，
  而不能与页面渲染器打包在一起

下面以使用 AMIS 作为渲染引擎的页面渲染器 `amis` 为例进行说明。

首先，在构建的入口脚本 `/src/amis/index.js`
中定义并调用页面渲染器函数 `render`：

```js title="/src/amis/index.js"
import 'amis/sdk/sdk';
// Note：当前项目不是 React 项目，只能以 SDK 方式使用 AMIS
// https://baidu.github.io/amis/zh-CN/docs/start/getting-started
const amis = amisRequire('amis/embed');

const conf = window.__APP_SITE_CONFIG__;
render(conf);

function render(conf) {
  amis.embed(/* ... */);
}
```

由于，在渡舟平台中，`Site` 的入口 HTML 将由 Java 后端服务动态生成，
而在运行环境中没有对 js 的构建支持，并且只有高版本的浏览器才支持原生的模块导入，
因此，为了支持更多的浏览器，只能采用 `<script/>` 标签载入页面渲染函数。

但，若要使用该函数，则需要将其定义为全局函数后再调用，
或者，在入口脚本中直接调用该函数，但其配置数据从指定的全局变量中获取。
为了降低对入口 HTML 的维护难度，简化其结构，渡舟平台采用了第二种方案，
也就是，将逻辑代码尽可能地移到 js 脚本中，入口 HTML
仅负责 `Site` 页面加载和渲染所必须的最小工作内容，
即，显示开屏动画、加载入口脚本即可。

以下便为在运行环境中所生成的入口 HTML 的主要内容：

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <!-- title 和 logo 等配置 -->

    <style>/* 开屏动画样式 */</style>

    <script>
      window.__APP_SITE_CONFIG__ = {
        el: '#app',
        // 动态填充的 Site 数据
      };
    </script>
  </head>
  <body>
    <div id="app"></div>

    <script src="/js/renderer-amis-0.1.0.js"></script>
  </body>
</html>
```

该内容与开发页面渲染函数所使用的开发页面 `/index.html` 内容也是基本一致的，
主要差异就是 `window.__APP_SITE_CONFIG__` 使用的是测试数据，并且，
引入的页面渲染函数脚本为源码路径
`<script type="module" src="/src/amis/index.js"></script>`。

然后，在 `vite.config.js` 中指定要构建的页面渲染函数，
并将其依赖的渲染引擎单独打包：

```js {16-17,45} title="vite.config.js"
import { defineConfig } from 'vite';

import pkg from './package.json';
import amisPkg from './node_modules/amis/package.json';

export default defineConfig(() => {
  return {
    // ...
    build: {
      // 增加构建产物的兼容范围
      target: 'es2015',
      rollupOptions: {
        // 摇树优化，将未使用的导出函数移除
        treeshake: true,
        input: {
          [`js/renderer-amis-${pkg.version}`]:
            path.join(__dirname, 'src/amis/index.js')
        },
        output: {
          // 入口脚本的位置
          entryFileNames: '[name].js',
          // 各个依赖模块独立打包，并放在 js 目录下
          chunkFileNames: 'js/[name].js',
          manualChunks(id) {
            function include_any(libs) {
              for (let lib of libs) {
                if (id.includes(
                      '/node_modules/' + lib + '/'
                    )) {
                  return true;
                }
              }
              return false;
            }

            if (
              include_any([
                'amis',
                'amis-ui',
                'amis-formula',
                'amis-core',
                'video-react'
              ])
            ) {
              return `lib/${amisPkg.name}-${amisPkg.version}`;
            }
          }
        }
      }
    },
  };
});
```

- `entryFileNames: '[name].js'` 配置的是入口脚本的构建产物名称，
  而入口脚本则是在 `rollupOptions.input` 中指定的，`input`
  的键名即为 `[name]`，并且该键名可以是文件路径形式，
  该文件路径相对于构建产物目录 `dist`
- `chunkFileNames: 'js/[name].js'` 用于配置模块的构建产物名称，
  而要生成哪些模块，则通过 `rollupOptions.output.manualChunks`
  函数指定，该函数接受以模块路径为 `id` 的值，在根据该 `id`
  返回模块名称，若不同 `id` 返回的是相同的名称，则其将被打包到一个文件中，
  所以，可以将 AMIS 等引擎相关的组件打包在一起。
  模块名称将替换 `chunkFileNames` 中的 `[name]`，
  同时，其名称也可以是文件路径，该路径依然是相对于 `dist` 的

## 开屏加载动画

```html {16,19,36,42,46,50,55} title="index.html"
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      html,
      body {
        margin: 0;
        padding: 0;
        min-width: 0;
        min-height: 0;
        width: 100%;
        height: 100%;
        --Spinner-bg: url(/public/loading.svg);
      }

      .loading::after {
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease-out;
        transition-delay: 0.2s;

        /* 禁用鼠标事件 */
        pointer-events: none;

        /* 配置开屏动画 */
        overflow: hidden;
        position: absolute;
        top: 0;
        width: 100%;
        height: 100%;

        content: '';
        background-image: var(--Spinner-bg);
        background-color: white; /* 遮挡底部元素 */
        background-position: center;
        background-size: 12rem;
        background-repeat: no-repeat;
      }
      .loading.done::after {
        opacity: 0;
      }

      .loading > * {
        opacity: 0;
        transition: opacity 0.5s ease-in;
      }
      .loading.done > * {
        opacity: 1;
      }
    </style>
  </head>
  <body class="loading">
    <div id="app"></div>
  </body>
</html>
```

## 参考

- [nop-chaos/nop-site/vite.config.ts](https://gitee.com/canonical-entropy/nop-chaos/blob/master/packages/nop-site/vite.config.ts)

---
title: 设计
description: 了解认证与鉴权的设计
authors:
  - flytreleft
---

import Header from '@site/docs/\_header.md';

<Header />

- 用户认证与组织机构合并管理，以避免拆分后 `User`
  与 `Role`、`Department` 关联关系维护的复杂度，
  但分包管理 ORM 模型：`.auth`、`.org`
- 会话日志
- 操作日志
- 权限
  - 数据权限（`Data`）：控制可访问数据范围和字段，限制可执行操作（增删改查）
  - 资源权限（`Resource`）
  - 资源操作权限（`Action`）
- 所有资源（接口、页面、数据）都需要用户授权才可访问，
  不需要登录便可访问的资源，其本质是授权给了**匿名用户**，
  因此，匿名用户是一个特殊的系统用户，每次访问都会生成不同的
  `Access Token`
  - 内部服务之间仅需检查 Token 的有效性即可，无需从数据库做比对：
    对 Token 解码并比对帐号和一个随机值
- **多租户支持**：不同租户有不同的权限范围
  - 通过差量机制提供实现上的支持

```plantuml
note as A
  - 未明确授权时，非匿名资源、接口等均不可被访问
  - 内置匿名角色，可对匿名用户做权限控制。
    匿名访问也需记录操作日志和会话日志
  - Resource、Action 为静态数据，
    在编码期确定，运行期从 DSL 中读取。
    在各个模块中声明，再在运行期扫描并合并
end note

class User {
  String id
  String nickName
  String firstName
  String familyName
  String gender
  String avatar
  String email
  String phone
  .. 用户状态 ..
  String status
  .. 登录方式 ..
  List<UserLoginType> loginTypes
}

class UserLoginType {
  String id
  .. 绑定的用户 ..
  User user
  .. 类型编码：账密登录、微信登录等 ..
  String code
  .. 是否已验证 ..
  boolean verified
  .. 是否已禁用 ..
  boolean disabled
  .. 过期时间：到期后，该登录方式自动失效 ..
  Date expiredAt

  .. 帐号名：密码登录时使用 ..
  String account
  .. 密码 ..
  String password
  .. 密码加盐 ..
  String passwordSalt

  .. 在第三方系统中对应的用户唯一标识 ..
  String extUid
}

class UserRole {
  String id
  User user
  Role role
}

class Role {
  String id
  .. 名称 ..
  String name
  .. 描述说明 ..
  String description
}

class RolePermission {
  String id
  .. 被授权的角色 ..
  Role role
  .. 可访问的资源：对应 Resource#code ..
  String resource
  .. 可对资源执行的操作：对应 Action#code ..
  String[] actions
}

class Resource {
  .. 唯一编码：可使用路径分隔符 ..
  String code
  .. 名称 ..
  String name
  .. 描述说明 ..
  String description
  .. 子资源列表 ..
  List<Resource> children
  .. 与资源关联的操作列表 ...
  List<Action> actions
}

class Action {
  .. 唯一编码 ..
  String code
  .. 名称 ..
  String name
  .. 操作对象与操作名称 ..
  String bizAction
  String bizObjName
  .. 描述说明 ..
  String description
}

note right of Action
  用于控制对
  <b>{bizObjName}__{bizAction}</b>
  接口的访问
end note

class Department {

}

class UserDepartment {
  String id
  User user
  Department department
}

note right of UserDepartment
  通过中间表绑定部门和用户，
  通过小表做关联查询，可降低性能影响
end note

class UserSubstitution {
  String id
  .. 代理人类型：程序代理、用户代理 ..
  Type type
  .. 代理人：程序代理无此设置 ..
  User substitutor
  .. 被代理人 ..
  User substituted
  .. 代理开始时间 ..
  Date startTime
  .. 代理结束时间 ..
  Date endTime
  .. 代理人权限列表：实际为与被代理人所拥有权限的交集 ..
  List<RolePermission> permissions
}
```

---
title: 第二版
description: 系统的第二版实现
authors:
  - flytreleft
---

import Header from '../../../\_header.md';

<Header />

这一版将实现对 `Employee` 的条件查询，并抽取模型的基础 DSL。

下载 [nop-demo.orm.v2.xlsx](./files/nop-demo.orm.v2.xlsx) 并覆盖工程目录下的
`model/nop-demo.orm.xlsx` 文件，再通过 `nop-cli gen` 生成模型和前端页面：

```bash
export JAVA_HOME=/usr/lib/jvm/java-17-openjdk

${JAVA_HOME}/bin/java \
  -Dfile.encoding=UTF8 \
  -jar ./nop-cli.jar \
  gen -t=/nop/templates/orm \
  ./model/nop-demo.orm.xlsx
```

- 可用的空间见 Nop 平台中的 `nop-web/src/main/resources/_vfs/nop/web/xlib/control.xlib`

## 员工列表左侧添加过滤树

- 按地区和部门的树结构过滤

## 员工列表上部添加过滤查询

## 地区和部门沿其父级显示全部父节点名称

该定制将涉及以下几个方面：
- 在 GraphQL 的查询 Selection 中需显示设置获取足够的嵌套层级的 `parent{name}`
- `parent` 的显示组件上需沿 `parent` 路径获取全部父节点名称后，再拼接在一起显示，
  但仅显示内容按此变化，隐射的 `parent.id` 依然为直接父节点

```xml title="nop-demo-delta/src/main/resources/_vfs/_delta/v2/nop/demo/pages/Region/Region.view.xml"
<?xml version="1.0" encoding="UTF-8" ?>
<view x:extends="super" x:schema="/nop/schema/xui/xview.xdef" xmlns:x="/nop/schema/xdsl.xdef">

    <pages>
        <crud name="main" grid="list">
            <table>
                <!-- api 的结构和配置参考 https://baidu.github.io/amis/zh-CN/docs/types/api -->
                <api url="@query:Region__findPage" gql:selection="{@pageSelection}">
                    <!-- {total, page, items} = payload.data -->
                    <adaptor><![CDATA[
                        const mutate = (items) => {
                            items.forEach((item) => {
                                let p = item.parent;
                                const names = [];
                                while (p) {
                                    names.push(p.name);
                                    p = p.parent;
                                }

                                if (item.parent) {
                                    item.parent.name = names.reverse().join(' / ');
                                }
                            });
                        };
                        mutate(payload.data.items);

                        return payload;
                    ]]></adaptor>
                </api>
            </table>
        </crud>
    </pages>
</view>
```

将原来的表格类型由 `tree-list` 改为 `list`，且 GraphQL query 改为 `Region__findPage`，
同时，GraphQL selection 需改为 `{@pageSelection}`。

不过，`{@pageSelection}` 仅包含一层父级结构，而改造是需要获取全部层级的父结构，
所以，需要对 `{@pageSelection}` 的值进行调整。

`api` 的生成逻辑定义在 `/nop/web/xlib/web/grid_crud.xpl` 中：

```xml title="/nop/web/xlib/web/grid_crud.xpl"
<c:unit ...>
  ...
  <crud ...>
    ...
    <api xpl:attrs="xpl('thisLib:NormalizeApi', gridApi, genScope)" .../>
  </crud>
</c:unit>
```

其最终会调用 Xpl 函数 `NormalizeApi` 根据在 `/pages/Region/Region.view.xml` 中
`api` 上的配置（放在 `gridApi` 对象上）生成对应的前端组件。

```yaml title="nop-demo-delta/src/main/resources/_vfs/_delta/v2/nop/demo/pages/Region/main.page.yaml"
x:gen-extends: |
  <web:GenPage view="Region.view.xml" page="main" xpl:lib="/nop/demo/pages/Region/web.xlib" />
```

> `xpl:lib` 必须为 Delta 层的绝对路径，不能是相对路径。

```xml title="nop-demo-delta/src/main/resources/_vfs/_delta/v2/nop/demo/pages/Region/web.xlib"
<?xml version="1.0" encoding="UTF-8" ?>
<lib xmlns:x="/nop/schema/xdsl.xdef"
     x:schema="/nop/schema/xlib.xdef"
     x:extends="/nop/web/xlib/web.xlib">

  <tags>
    <NormalizeApi>
      <attr name="api"/>
      <attr name="genScope"/>

      <source><![CDATA[
        if(!api) return null;

        genScope.pageSelection = genScope.pageSelection?.$renderTemplateForScope('parent{', '}', {
          name: 'parent{name,parent{name,parent{name,parent{name}}}}'
        });

        return _.filterNull({...api,
            url:api.url.$renderTemplateForScope("{@","}",genScope),
            "gql:selection": api['gql:selection']?.$renderTemplateForScope('{@','}',genScope),
            data: api.withFormData ? genScope.formData : api.data
        })
      ]]></source>
    </NormalizeApi>
  </tags>
</lib>
```

> `$renderTemplateForScope` 为定义在 `io.nop.api.core.util.ApiStringHelper`
> 上并绑定到 `String` 类型上的扩展函数，其在这里的作用是将字符串中的 `{@var}` 替换为 `var` 变量的值，
> 其中，`var` 为 `genScope` 中的 key 名称。

## 地区和部门的选择弹窗添加过滤

## 注意事项

## 参考资料

- [Excel 数据模型](https://gitee.com/canonical-entropy/nop-entropy/blob/master/docs/dev-guide/model/excel-model.md)：
  了解各列的配置及作用
- [可逆计算理论中的 Delta 合并算法](https://gitee.com/canonical-entropy/nop-entropy/blob/master/docs/dev-guide/xlang/x-override.md)：
  了解可用的合并方式
- [XMeta 元数据](https://gitee.com/canonical-entropy/nop-entropy/blob/master/docs/dev-guide/xlang/xmeta.md)：
  了解 XMeta 的结构

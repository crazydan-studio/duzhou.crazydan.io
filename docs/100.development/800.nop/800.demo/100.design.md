---
title: 功能设计
description: 设计各个功能模块
authors:
  - flytreleft
---

import Header from '../../../\_header.md';

<Header />

一个多租户的平台实际上是包含两套系统，一套为租户管理系统，
另一套为租户服务系统，前者负责管理租户和资源分配，
后者则是为平台的租户提供其所需的业务服务。

## DSL 设计

采用**自顶向下**的设计模式，并仅声明要做什么，而不涉及如何做的问题。

将整个软件从上到下划分为：**平台 -> 系统 -> 服务 -> 模块**。
平台直接面向使用者，为用户提供访问入口，并将用户触发的请求转发给系统；
而系统是一类功能业务的集合，负责响应用户业务处理需求；
而服务为业务系统的功能集合，负责处理一组业务功能，为可独立运行的实体；
模块则是对业务功能的组织，一般为一级菜单。

也就是，一个或多个模块组成一个服务，一个或多个服务组成一个系统，
一个或多个系统组成一个平台，一个平台面向一个或多个用户。

```xml
<platform name="多租户组织机构数据管理平台" domain="duzhou.io">
  <!--
  @url 用于标识请求的路由，也就是平台将根据 url 将对应的请求路由到指定的系统，
    再由系统路由到指定的服务
  @domain 被托管系统的访问域名，该系统是被独立访问和管理的，
    平台只负责对其运行资源的分配和管理。注：对其请求的路由还是得经过平台
  -->

  <system name="平台用户系统" url="/user">
    <!-- 一个服务就是一套可运行代码，但实际运行的可能会有多个服务实例 -->
    <service name="用户服务" url="">
      <module name="帐号管理" url="/account"></module>
      <module name="权限管理" url="/permission"></module>
      <module name="用户管理" url="/management"></module>
    </service>
  </system>

  <system name="租户管理系统" url="/tenant">
    <service name="租户管理服务" url="/management"></service>
    <service name="租户计费服务" url="/charging"></service>
    <service name="租户自服务" url="/self-service"></service>
  </system>

  <!--
  租户应用，本质上可视为在数据中添加了租户标识的普通应用，
  实际开发的应用中可对数据模型始终加上租户标识属性，
  从而便于直接接入到多租户平台中。也可以通过 Delta 机制无缝实现对多租户的支持。

  租户应用系统，对于平台而言属于托管系统，平台仅负责维护其正常运行，
  并对未激活的租户应用系统做访问限制，其余的均由系统自身处理。
  -->
  <system name="租户应用系统 A" url="/a" domain="tenant.duzhou.io">
    <!-- 用户服务为通用服务 -->
    <service name="用户服务" url="/user">...</service>

    <service name="组织机构服务" url="/org"></service>
  </system>

  <system name="租户应用系统 B" url="" domain="b.tenant.duzhou.io">
  </system>
</platform>
```

平台（Platform）和系统（System）均为抽象概念，二者只是用于对不同层面的服务进行分组，
以方便对服务职能和作用范围进行管理。

平台自身将提供如下组件或服务，用于部署、监控和管理包括其自身在内的所有服务：
- `Agent`：部署代理，其将被部署在任意可用的主机设备上，并主动接入到平台中，
  平台将通过 agent 部署各类系统服务，并会动态下发相关配置，
  以让其所部署的服务将日志、监控数据等发送到平台指定的服务中
  - 接入平台需要提供唯一的**接入码**，其由平台生成，
    在通过平台下载 agent 安装包时生成，仅可使用一次，且有有效期
  - 平台提供的 agent 将会内置**认证公钥**，以确保 agent 的合法性，
    并用于后续平台与 agent 交互的 SSL 证书
  - 由服务确定下发的配置哪些可即时生效，对于不能即时生效的配置，
    在平台侧由用户确定是否需要重启
- `Gateway`：服务网关，负责路由外部请求到平台内部服务及其被托管服务上
  - 根据 url 路径和域名路由请求，对租户系统，需在请求头中附加**租户标识**
  - 由平台通过规则下发到 agent，再由 agent 更新到 gateway

## 功能模块

### 平台管理

- 平台的用户、角色与权限

### 租户管理

- 不同的租户有不同的访问入口，同时支持域名和子路径方式
- 租户增、删、改、激活/禁用
- 租户租用期限设置：到期自动禁用
- 租户缴费：缴费后自动激活
- 各类租户可使用功能设置：租户的功能权限

### 租户自服务

- 租户自服务，等同于组织机构系统的管理员操作，
  租用者通过其入口地址进入系统后，便于自部署服务的管理模式相同

### 用户及权限模块

## 技术实现

- 单体服务模式
- 租户数据库支持
  - 单库分表：通过 `租户标识` 分表
  - 单库多表：通过 `租户标识` 命名数据表
  - 水平扩展：部署多套服务实例，并配备独立的数据库，
    按以上模式做租户数据隔离，再按 `租户标识` 或地域制定分流规则，
    将各租户的访问切换到对应的运行实例上
    - 新加入的服务仅需标识分流所需要的识别信息（标签）即可，
      剩下的由网关实施分流控制
    - 多级网关：第一级为租户分流网关，第二级为租户服务网关

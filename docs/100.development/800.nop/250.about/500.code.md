---
title: 代码分析
description: 了解 Nop 平台的代码处理逻辑
authors:
  - flytreleft
---

import Header from '../../../\_header.md';

<Header />

## 整体架构

同一信息在不同的坐标系中具有不同的表现形式（表象）。
Nop 平台以 DSL 方式定义了一个与具体实现无关的**领域坐标系**，
由 DSL 来描述业务和数据模型，再通过 `Generator` 将
DSL 转换到具体的**实现坐标系**（不同语言的代码，就是不同的实现坐标系）上，
从而实现从业务领域到具体实现的**坐标投射**。

```plantuml
agent dsl as "领域坐标系"
agent code as "实现坐标系"

dsl -right(0)-> code: 投射: Generator(DSL)
```

> 同样的业务在不同的框架、不同的语言中的表达式具有不同的形式，
> 但是这些不同的形式背后存在统一的抽象内容，
> 然后把它投射到不同的坐标系中就自动产生了不同的具体表达。

可逆计算下的 DSL 还支持差量（Delta）和差量合并（定点修改坐标系内确定位置的数据），
可以从业务层面实现对应用的定制开发，并且可以通过在 DSL 上附加不同的 Delta
来保证同一信息在不同形式之间的双向自由转换。而差量合并，则是一种对需求变动的最小度量机制，
也就是，以最少的变动量来精确描述需求的变化，属于一种更高层次的复用技术。

用数学公式来表达即为：

<!-- https://artofproblemsolving.com/wiki/index.php/LaTeX:Symbols -->

$$
\begin{aligned}

App &= \Delta Delta \oplus Generator\langle DSL \rangle

\end{aligned}
$$

在 Nop 平台中的实现机制如下：

<!-- https://plantuml.com/deployment-diagram -->

```plantuml
file dsl as "DSL"
entity delta as "Delta"
control extends as "x-extends"
component generator as "Generator"
agent other_dsl as "其他 DSL"
agent code as "代码"
agent amis_json as "AMIS JSON"
agent other as "..."

dsl --> extends
delta --> extends
extends --> generator: XNode
generator --> other_dsl
generator --> code
generator --> amis_json
generator --> other
```

也就是，可以将 Nop 平台看做是一个 DSL 虚拟机，其将
DSL 与 Delta 做差量合并（`x-extends`）并生成 `XNode`，再通过
`Generator` 生成代码、AMIS JSON（页面布局结构）或其他形式的输出。

若与生物的演化进行类比，可以把 DNA 看作是某种承载信息的 DSL，
生物的成长过程便对应于 `Generator`，它根据 DSL
的信息并结合**环境信息**塑造出生物的本体。
同时生物在应对具体问题挑战的时候，还可以利用外部的各种 Delta。
比如人可以穿上潜水服这个 Delta，获得在水中活动的能力，可以加上不同厚度的衣服，
获得在极寒和极热地区活动的能力。而一般的动植物能够加装的 Delta 很少，
比如飞鸟，如果它在水中长时间潜水，飞行用的翅膀反而是一种阻碍。

## DSL 解析

<!-- https://plantuml.com/sequence-diagram -->

```plantuml
autonumber "<b>[000]"

entity "SchemaLoader" as loader
entity "CoreInitialization" as init
entity "ICoreInitializer" as init_others
entity "XLangCoreInitializer" as init_xlang
entity "ResourceComponentManager" as res_man

== 初始化 ==

init -> init: ~#initialize()
activate init
  init -> init_others: ~#initialize()
  activate init_others
    init_others -> init:
  deactivate init_others

  init -> init_xlang: ~#initialize()
  activate init_xlang
    init_xlang -> init_xlang: ~#registerXDef()
    activate init_xlang
      init_xlang -> init_xlang: 配置 XDef 加载器:\nComponentModelConfig#loader
      init_xlang -> init_xlang: 配置 XMeta 转换器:\nComponentModelConfig#transformer

      init_xlang -> res_man: 注册 ComponentModelConfig:\n~#registerComponentModelConfig(config)
      activate res_man
        res_man -> res_man:
        res_man -> init_xlang: 返回 Cancellable
      deactivate res_man
    deactivate init_xlang

    init_xlang -> init:
  deactivate init_xlang
deactivate init

== 解析 ==

loader -> loader: ~#loadXDefinition(modelPath)
activate loader
  loader -> res_man: ~#loadComponentModel(modelPath, "xdef")
  activate res_man
    res_man -> res_man:
    res_man -> loader: 返回 IXDefinition
  deactivate res_man
deactivate loader

loader -> loader: ~#loadXMeta(modelPath)
activate loader
  loader -> res_man: ~#loadComponentModel(modelPath, "xmeta")
  activate res_man
    res_man -> res_man:
    res_man -> loader: 返回 IObjMeta
  deactivate res_man
deactivate loader

== 销毁 ==

init -> init: ~#destroy()
activate init
  init -> init_others: ~#destroy()
  activate init_others
    init_others -> init:
  deactivate init_others

  init -> init_xlang: ~#destroy()
  activate init_xlang
    init_xlang -> init_xlang: ICancellable#cancel()
    activate init_xlang
      init_xlang -> res_man: 卸载
      activate res_man
        res_man -> res_man:
        res_man -> init_xlang:
      deactivate res_man
    deactivate init_xlang

    init_xlang -> init:
  deactivate init_xlang
deactivate init
```

JSON 序列化 XDef 和 XMeta：

```java
AppConfig.getConfigProvider().updateConfigValue(CFG_JSON_PARSE_IGNORE_UNKNOWN_PROP, true);
// 不初始化 Ioc
CoreInitialization.initializeTo(new IocCoreInitializer().order() - 1);


IXDefinition xdef = SchemaLoader.loadXDefinition("/nop/schema/orm/orm.xdef");

String json = JsonTool.serialize(xdef.toNode(), true);
log.info(json);

IObjMeta xmeta = SchemaLoader.loadXMeta("/nop/schema/orm/orm.xdef");
json = JsonTool.serialize(xmeta.toNode(), true);
log.info(json);


CoreInitialization.destroy();
```

## 注意事项

## 参考资料

- [DSL 模型文件加载](https://gitee.com/canonical-entropy/nop-entropy/blob/master/docs/dev-guide/vfs/model-loader.md)
